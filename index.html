<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>乌兹别克语口语速成 - 智能闪卡</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 自定义样式补充 */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* 防止手机端下拉刷新干扰 */
        }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* 隐藏滚动条但保留功能 */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 (已修复：使用 <g> 包裹多路径图标) ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                // 单路径图标
                Volume2: <path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />,
                ChevronLeft: <path d="M15 18l-6-6 6-6" />,
                ChevronRight: <path d="M9 18l6-6-6-6" />,
                Shuffle: <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" />,
                Play: <polygon points="5 3 19 12 5 21 5 3" />,
                Key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                
                // 多路径图标 (关键修复：添加 <g> 包裹)
                RotateCw: <g><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></g>,
                Pause: <g><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></g>,
                BookOpen: <g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></g>,
                FileAudio: <g><path d="M17.5 19H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.5L19 7.5V17a2 2 0 0 1-1.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M10 13a2 2 0 0 0 4 0" /><path d="M9 13v2a3 3 0 0 0 6 0v-2" /></g>,
                Mic: <g><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="23" /><line x1="8" y1="23" x2="16" y2="23" /></g>,
                Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
                X: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                Save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>,
                List: <g><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></g>,
                Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 3v4" /><path d="M3 5h4" /><path d="M3 9h4" /></g>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>
            };

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 核心逻辑 ---

        const getAudioFileName = (text) => {
            const safeName = text.toLowerCase().replace(/['ʻ`]/g, '').replace(/\s+/g, '_');
            return `/audio/${safeName}.mp3`;
        };

        const pcm16ToWavBlob = (base64Audio, sampleRate = 24000) => {
            const audioData = atob(base64Audio);
            const dataLength = audioData.length;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            const u8 = new Uint8Array(buffer, 44);
            for (let i = 0; i < dataLength; i++) {
                u8[i] = audioData.charCodeAt(i);
            }

            return new Blob([view], { type: 'audio/wav' });
        };

        const VOCABULARY_DATA = [
            { id: 1, title: "第一篇：问候与告别", words: [ { uz: "salom", cn: "你好，您好" }, { uz: "qalay", cn: "怎么样" }, { uz: "xayrli", cn: "开心的、愉快的" }, { uz: "tong", cn: "早晨、早上" }, { uz: "kech", cn: "晚上" }, { uz: "xush kelibsiz", cn: "欢迎" }, { uz: "ism", cn: "名字、姓名" }, { uz: "shirin", cn: "甜蜜的、好吃的" }, { uz: "tush ko'r-", cn: "做梦" }, { uz: "dam ol-", cn: "休息" }, { uz: "sog'lik", cn: "健康" }, { uz: "emas", cn: "不是、不" }, { uz: "yaqin vaqt", cn: "最近" }, { uz: "band", cn: "忙" }, { uz: "unchalik", cn: "那么" }, { uz: "yoshga kir-", cn: "年龄、是……岁" }, { uz: "qarib qol-", cn: "变老" }, { uz: "uzoq umr", cn: "长寿" }, { uz: "tanish-", cn: "认识" }, { uz: "xursand", cn: "荣幸、高兴" } ] },
            { id: 2, title: "第二篇：介绍家人", words: [ { uz: "oila", cn: "家庭" }, { uz: "kishi", cn: "人" }, { uz: "yolg'iz", cn: "单独的" }, { uz: "farzand", cn: "子女、后代" }, { uz: "yana", cn: "还" }, { uz: "boshqa", cn: "其他" }, { uz: "kasb", cn: "职业、专业" }, { uz: "harbiy", cn: "军人" }, { uz: "hamshira", cn: "护士" }, { uz: "olim", cn: "科学家、学者" }, { uz: "san'atshunos", cn: "艺术家" }, { uz: "nafaqada", cn: "退休" }, { uz: "talaba", cn: "大学生" }, { uz: "oila qur-", cn: "结婚、建立家庭" }, { uz: "oshpaz", cn: "厨师" }, { uz: "turmush o'rtog'i", cn: "爱人、生活伴侣" }, { uz: "qo'shni", cn: "邻居" }, { uz: "uy bekasi", cn: "家庭主妇" }, { uz: "tamomla-", cn: "完成" }, { uz: "tarjimon", cn: "翻译" }, { uz: "ista-", cn: "想、想要" } ] },
            { id: 3, title: "第三篇：就餐", words: [ { uz: "ovqatlan-", cn: "吃饭" }, { uz: "nonushta", cn: "早餐" }, { uz: "odatda", cn: "通常、平常" }, { uz: "qahva ich-", cn: "喝咖啡" }, { uz: "yaxshi ko'r-", cn: "喜欢" }, { uz: "tuxum", cn: "鸡蛋" }, { uz: "oshxona", cn: "餐厅、食堂" }, { uz: "taxminan", cn: "大约、大概" }, { uz: "tushlik", cn: "午餐" }, { uz: "lag'mon", cn: "拉面" }, { uz: "kam", cn: "少、不足" }, { uz: "ko'pchilik", cn: "大家" }, { uz: "osh", cn: "抓饭" }, { uz: "tayyorla-", cn: "准备" }, { uz: "kechki ovqat", cn: "晚餐" }, { uz: "doim", cn: "经常" }, { uz: "ko'cha", cn: "街、巷" }, { uz: "pivo ich-", cn: "喝啤酒" }, { uz: "aroq ich-", cn: "喝白酒" }, { uz: "umuman", cn: "基本上、完全" }, { uz: "yaqin atrof", cn: "附近" }, { uz: "narigi tamon", cn: "对面" }, { uz: "buyurtma qil-", cn: "点(餐)、预定" }, { uz: "mazali", cn: "好吃、香" } ] },
            { id: 4, title: "第四篇：在学校", words: [ { uz: "boshlang'ich maktab", cn: "小学" }, { uz: "mashhur", cn: "著名的、出名的" }, { uz: "o'rta maktab", cn: "中学" }, { uz: "universitet", cn: "大学" }, { uz: "qiziqarli", cn: "有趣的" }, { uz: "dars o't-", cn: "上课、教书" }, { uz: "fan nomzodi", cn: "副博士" }, { uz: "professor", cn: "教授" }, { uz: "deyarli", cn: "几乎、差不多" }, { uz: "dars eshit-", cn: "听课" }, { uz: "institut", cn: "学院、研究所" }, { uz: "mutaxassislik", cn: "专业" }, { uz: "til va adabiyot", cn: "语言文学" }, { uz: "iqtisodiyot", cn: "经济学" }, { uz: "tibbiyot", cn: "医学" }, { uz: "kutubxona", cn: "图书馆" }, { uz: "qiroatxona", cn: "阅览室" }, { uz: "maydon", cn: "操场、运动场" }, { uz: "sport musoboqasi", cn: "运动会" }, { uz: "o'z xohishi bilan", cn: "自愿地" }, { uz: "ishtirok et-", cn: "参加、参与" }, { uz: "zamonaviy", cn: "现代化的" }, { uz: "xorijlik talaba", cn: "留学生" }, { uz: "doktorant", cn: "博士学位" }, { uz: "grant", cn: "奖学金" }, { uz: "tirishqoq", cn: "勤奋、努力" } ] },
            { 
                id: 5, 
                title: "第五篇：找工作", 
                words: [
                    { uz: "oylik maosh", cn: "工资" },
                    { uz: "qo'shimcha ishlamoq", cn: "加班" },
                    { uz: "imtiyoz", cn: "优待" },
                    { uz: "tibbiy sig'urta", cn: "医疗保险" },
                    { uz: "ish sharoiti", cn: "工作条件" },
                    { uz: "shartnoma", cn: "合同" },
                    { uz: "ish muhiti", cn: "工作环境" },
                    { uz: "premiya", cn: "奖金" },
                    { uz: "ishga joylashmoq", cn: "参加工作" },
                    { uz: "ish davomiyligi", cn: "工作时长" }
                ]
            },
            { id: 6, title: "第六篇：出行", words: [ { uz: "hozir", cn: "现在" }, { uz: "avtobus bekati", cn: "公交车站" }, { uz: "to'g'riga qarab yurmoq", cn: "直走" }, { uz: "ko'cha boshi", cn: "路口" }, { uz: "yaqin atrof", cn: "附近" }, { uz: "chaqir-", cn: "叫、呼唤" }, { uz: "haydovchi", cn: "司机" }, { uz: "narxni gaplashmoq", cn: "谈价钱" }, { uz: "kino chiptasi", cn: "电影票" }, { uz: "metro", cn: "地铁、轻快铁" }, { uz: "yoʻlga chiq-", cn: "出发、上路" }, { uz: "rejalashtir-", cn: "计划、安排" }, { uz: "qadimiy", cn: "古老的" }, { uz: "poyezd", cn: "火车" }, { uz: "samolyot", cn: "飞机" }, { uz: "vokzal", cn: "火车站" }, { uz: "eltib qo'y-", cn: "送到" }, { uz: "aeroport", cn: "机场" }, { uz: "mehmonxona", cn: "酒店" }, { uz: "bron qil-", cn: "预订" }, { uz: "muzey", cn: "博物馆" }, { uz: "avval", cn: "首先" }, { uz: "maydon", cn: "广场、场地" }, { uz: "so'ng", cn: "然后" }, { uz: "savdo markazi", cn: "购物中心" }, { uz: "mashhur obidalar", cn: "著名景点" }, { uz: "quvnoq", cn: "愉快的" }, { uz: "safar", cn: "旅途、旅程" } ] },
            { id: 7, title: "第七篇：谈天气和季节", words: [ { uz: "ob-havo ma'lumoti", cn: "天气预报" }, { uz: "tuman tush-", cn: "起雾、有雾" }, { uz: "qattiq", cn: "强烈的、坚硬的" }, { uz: "shamol es-", cn: "起风、刮风" }, { uz: "balki; ehtimol", cn: "可能" }, { uz: "kuchli", cn: "有力的、强的" }, { uz: "charaqla-", cn: "闪耀的、闪烁的" }, { uz: "bulut", cn: "云" }, { uz: "qopla-", cn: "布满、笼罩" }, { uz: "soyabon", cn: "雨伞" }, { uz: "qor yog'-", cn: "下雪" }, { uz: "kiy-", cn: "穿" }, { uz: "ma'qul", cn: "好的,同意" }, { uz: "fasl", cn: "季节" }, { uz: "bahor", cn: "春" }, { uz: "yoz", cn: "夏" }, { uz: "kuz", cn: "秋" }, { uz: "qish", cn: "冬" }, { uz: "iliq", cn: "温暖的" }, { uz: "jazirama", cn: "酷热" }, { uz: "kundan kunga", cn: "一天比一天" }, { uz: "shimol", cn: "北、北部" }, { uz: "janub", cn: "南、南部" }, { uz: "daraxt barglari", cn: "树叶" }, { uz: "salqin", cn: "凉爽的" }, { uz: "nam", cn: "潮湿、湿润的" }, { uz: "quruq", cn: "干、干燥的" }, { uz: "chaqmoq chaq-", cn: "闪电" }, { uz: "meva-sabzavotlar", cn: "水果蔬菜" } ] },
            { id: 8, title: "第八篇：打电话", words: [ { uz: "Allo (labbay)", cn: "喂" }, { uz: "xonim", cn: "女士" }, { uz: "ozroq", cn: "少一点" }, { uz: "kutib tur-", cn: "等待、等一等" }, { uz: "chiqib ket-", cn: "出去" }, { uz: "xabar", cn: "消息、信息" }, { uz: "qoldir-", cn: "留下" }, { uz: "qo'ng'iroq qil-", cn: "打电话" }, { uz: "sinfdosh", cn: "同学、同班" }, { uz: "janob", cn: "先生、男士" }, { uz: "masala", cn: "问题、难题" }, { uz: "telefon raqami", cn: "电话号码" }, { uz: "bog'lan-", cn: "联系、被绑在一起" }, { uz: "qulay", cn: "方便、便利" }, { uz: "adash-", cn: "混淆、搞混" }, { uz: "yetkaz-", cn: "转达、送到" }, { uz: "aloqa", cn: "信号、联系" }, { uz: "qaytadan", cn: "重新、再一次" }, { uz: "ovozli xabar", cn: "语音消息" }, { uz: "kut-", cn: "等待、等" } ] },
            { id: 9, title: "第九篇：谈兴趣爱好", words: [ { uz: "qiziq-", cn: "感兴趣" }, { uz: "kompyuter o'yini", cn: "电脑游戏" }, { uz: "sport", cn: "体育运动" }, { uz: "yaxshi ko'r-", cn: "喜欢、喜爱" }, { uz: "yugurish", cn: "跑步" }, { uz: "basketbol", cn: "篮球" }, { uz: "musiqa tingla-", cn: "听音乐" }, { uz: "rasm chiz-", cn: "绘画、画画" }, { uz: "futbol ko'r-", cn: "看足球(比赛)" }, { uz: "o'yna-", cn: "玩、踢、打(球)" }, { uz: "bo'sh vaqt", cn: "空闲时间、自由时间" }, { uz: "xobbi", cn: "兴趣、爱好" }, { uz: "to'garak", cn: "兴趣小组" }, { uz: "qatnash-", cn: "参加" }, { uz: "television ko'rsatuv", cn: "电视节目" }, { uz: "dam olish kuni", cn: "周末" }, { uz: "teatr ko'rish", cn: "看戏剧" }, { uz: "qo'shiq kuylash", cn: "唱歌" }, { uz: "sayrga chiq-", cn: "散步、逛街" }, { uz: "gul o'stir-", cn: "养花、种花" }, { uz: "detektiv asar", cn: "侦探作品" }, { uz: "shaxmat o'yna-", cn: "下国际象棋" }, { uz: "badminton", cn: "羽毛球" }, { uz: "multfilm", cn: "动画片" }, { uz: "jangari film", cn: "动作片" }, { uz: "roman", cn: "小说" }, { uz: "telefon o'yini", cn: "手机游戏" }, { uz: "yangiliklar o'qi-", cn: "看新闻" } ] },
            { id: 10, title: "第十篇：谈家庭", words: [ { uz: "turmush qur-", cn: "结婚(男)" }, { uz: "turmushga chiq-", cn: "出嫁(女)" }, { uz: "sevgan qiz", cn: "女朋友" }, { uz: "yolg'iz", cn: "单身、单独地" }, { uz: "allaqachon", cn: "已经、早就" }, { uz: "farzand", cn: "子女" }, { uz: "o'z", cn: "自己" }, { uz: "alohida", cn: "特别的、特殊的" }, { uz: "sevgan yigit", cn: "男朋友" }, { uz: "yasha-", cn: "生活;住" }, { uz: "ko'p qavatli uy", cn: "高层楼房" }, { uz: "bir qavatli uy", cn: "平房" }, { uz: "homilador bo'l-", cn: "怀孕" }, { uz: "egizak", cn: "双胞胎" }, { uz: "bog'cha", cn: "幼儿园" }, { uz: "ta'tilga chiq-", cn: "放假" }, { uz: "qarindosh-urug'", cn: "亲戚" }, { uz: "ko'rmoq; ziyorat qil-", cn: "看望" }, { uz: "qaynona uyi", cn: "婆家" }, { uz: "onasining uyi", cn: "娘家" }, { uz: "katta oila", cn: "大家庭" }, { uz: "baxt", cn: "幸福" } ] },
            { id: 11, title: "第十一篇：在医院", words: [ { uz: "kasalxona; shifoxona", cn: "医院" }, { uz: "to'g'riga yur-", cn: "直走" }, { uz: "svetofor", cn: "红绿灯" }, { uz: "umumiy kasalxona", cn: "综合医院" }, { uz: "maxsus kasalxona", cn: "专科医院" }, { uz: "teri", cn: "皮肤" }, { uz: "yurak", cn: "心脏" }, { uz: "kasal qabul qilish bo'limi", cn: "门诊部" }, { uz: "navbatga yozil-", cn: "挂号" }, { uz: "ichki kasalliklar bo'limi", cn: "内科" }, { uz: "mutaxassis", cn: "专家" }, { uz: "og'ri-", cn: "疼痛" }, { uz: "shamolla-", cn: "感冒" }, { uz: "termometr", cn: "体温计" }, { uz: "isitmalamoq", cn: "发热" }, { uz: "dori ich-", cn: "吃药" }, { uz: "dam ol-", cn: "休息" }, { uz: "dori olish joyi", cn: "取药处" } ] },
            { id: 12, title: "第十二篇：购物", words: [ { uz: "xarid", cn: "购物" }, { uz: "supermarket", cn: "超市" }, { uz: "sotib ol-", cn: "购买" }, { uz: "oziq-ovqat", cn: "食品" }, { uz: "dehqon bozori", cn: "农贸市场" }, { uz: "yangi", cn: "新鲜" }, { uz: "arzon", cn: "便宜" }, { uz: "mahsulot", cn: "商品" }, { uz: "savdo markazi", cn: "购物中心" }, { uz: "ko'ylak", cn: "衬衫;连衣裙" }, { uz: "ustki kiyim", cn: "上衣" }, { uz: "palto", cn: "大衣" }, { uz: "shim", cn: "裤子" }, { uz: "tufli", cn: "皮鞋" }, { uz: "kassa", cn: "收款台" } ] },
            { id: 13, title: "第十三篇：在机场", words: [ { uz: "aeroport", cn: "机场" }, { uz: "chipta", cn: "票" }, { uz: "navbatda tur-", cn: "排队" }, { uz: "pasport", cn: "护照" }, { uz: "ma'lumot berish joyi", cn: "问询处" }, { uz: "xavfsizlik nazorat punkti", cn: "安检口" }, { uz: "yuk", cn: "行李" }, { uz: "bortga chiqish joyi", cn: "登机口" }, { uz: "sumka", cn: "手提包" }, { uz: "yuklanadigan bagaj", cn: "托运行李" }, { uz: "oshib ket-", cn: "超重" }, { uz: "boj olinmaydigan do‘kon", cn: "免税店" }, { uz: "samolyot", cn: "飞机" }, { uz: "xavfsizlik kamari", cn: "安全带" } ] },
            { id: 14, title: "第十四篇：签证与入境", words: [ { uz: "viza", cn: "签证" }, { uz: "elchixona", cn: "大使馆" }, { uz: "chet el", cn: "外国" }, { uz: "sayohatchi", cn: "游客" }, { uz: "hujjat", cn: "文件" }, { uz: "talabnoma", cn: "申请信" }, { uz: "to‘ldir-", cn: "填写" }, { uz: "taklifnoma", cn: "邀请函" }, { uz: "aviachipta", cn: "飞机票" }, { uz: "muddat", cn: "期限" }, { uz: "elektron viza", cn: "电子签证" } ] },
            { id: 15, title: "第十五篇：留学", words: [ { uz: "ariza ber-", cn: "提交申请" }, { uz: "o‘qishga kirish", cn: "入学" }, { uz: "abituriyent", cn: "预科生" }, { uz: "grant", cn: "奖学金" }, { uz: "dastur", cn: "项目" }, { uz: "bepul ta’lim", cn: "免费教育" }, { uz: "oylik stipendiya", cn: "月生活费" }, { uz: "sug‘urta", cn: "保险" }, { uz: "tahsil olish", cn: "攻读学位" }, { uz: "ro‘yxatdan o‘tish", cn: "报名" }, { uz: "yotoqxona", cn: "宿舍" }, { uz: "ijaraga uy ol-", cn: "租房" } ] },
            { id: 16, title: "第十六篇：住宾馆", words: [ { uz: "mehmonxona", cn: "宾馆" }, { uz: "bir kishilik xona", cn: "单人间" }, { uz: "internet", cn: "互联网" }, { uz: "restoran", cn: "餐厅" }, { uz: "yordam ber-", cn: "帮助" }, { uz: "xodim", cn: "职员" }, { uz: "televizor", cn: "电视机" }, { uz: "kir yuv-", cn: "洗衣服" }, { uz: "garov puli", cn: "押金" }, { uz: "tozala-", cn: "打扫" }, { uz: "topshir-", cn: "退房/上交" }, { uz: "hisob qog‘ozi", cn: "账单" } ] },
            { id: 17, title: "第十七篇：租房", words: [ { uz: "vaqtinchalik", cn: "暂时的" }, { uz: "vokzal", cn: "火车站" }, { uz: "sharoit", cn: "条件" }, { uz: "jihozlangan", cn: "带家具的" }, { uz: "shinam", cn: "舒适的" }, { uz: "qidir-", cn: "寻找" }, { uz: "agentlik", cn: "中介" }, { uz: "uzoq muddatli", cn: "长期的" }, { uz: "qo‘shni bo‘l-", cn: "做邻居" }, { uz: "ijara haqqi", cn: "租金" }, { uz: "hisobla-", cn: "计算" } ] },
            { id: 18, title: "第十八篇：旅行", words: [ { uz: "sayohat", cn: "旅游" }, { uz: "mashhur joy", cn: "名胜古迹" }, { uz: "aylan-", cn: "转、看" }, { uz: "bilim ol-", cn: "获得知识" }, { uz: "yaylov", cn: "草原" }, { uz: "yo‘l ko‘rsatuvchi", cn: "导游" }, { uz: "manzara", cn: "风景" }, { uz: "suratga ol-", cn: "照相" }, { uz: "dengiz", cn: "大海" }, { uz: "tomosha qil-", cn: "欣赏" }, { uz: "cho‘l", cn: "戈壁" }, { uz: "vodiy", cn: "绿洲" } ] },
            { id: 19, title: "第十九篇：美容美发", words: [ { uz: "Go‘zallik saloni", cn: "美容院" }, { uz: "kosmetolog", cn: "美容师" }, { uz: "teri", cn: "皮肤" }, { uz: "namlantiruvchi", cn: "保湿的" }, { uz: "qosh", cn: "眉毛" }, { uz: "soch kestir-", cn: "剪发" }, { uz: "yuvdir-", cn: "洗头" }, { uz: "bo‘yat-", cn: "染发" }, { uz: "turmaklab qo‘y-", cn: "盘发" }, { uz: "jingalak soch", cn: "卷发" }, { uz: "manikyur", cn: "美甲" } ] },
            { id: 20, title: "第二十篇：谈业务", words: [ { uz: "hamkorlik", cn: "合作" }, { uz: "firma", cn: "公司" }, { uz: "mahsulot", cn: "产品" }, { uz: "ishlab chiqar-", cn: "生产" }, { uz: "biznes", cn: "生意" }, { uz: "loyiha", cn: "项目" }, { uz: "import-eksport", cn: "进出口" }, { uz: "jahon bozori", cn: "国际市场" }, { uz: "sarmoya", cn: "投资" }, { uz: "foyda", cn: "利润" }, { uz: "sifat", cn: "质量" }, { uz: "shartnoma", cn: "合同" } ] },
            { id: 21, title: "第二十一篇：银行邮局", words: [ { uz: "bank xizmati", cn: "银行业务" }, { uz: "pul o‘tkazmalari", cn: "汇款" }, { uz: "valyuta almashtirish", cn: "换汇" }, { uz: "plastik kartochka", cn: "银行卡" }, { uz: "pochta", cn: "邮局" }, { uz: "jo‘natma", cn: "邮件" }, { uz: "posilka", cn: "包裹" }, { uz: "konvert", cn: "信封" }, { uz: "manzil", cn: "地址" }, { uz: "pochta indeksi", cn: "邮编" } ] },
            { id: 22, title: "第二十二篇：接受与拒绝", words: [ { uz: "rozi", cn: "同意" }, { uz: "kelish-", cn: "谈妥" }, { uz: "taklif", cn: "建议" }, { uz: "qaror", cn: "决定" }, { uz: "rad qil-", cn: "拒绝" }, { uz: "afsus", cn: "遗憾" }, { uz: "majbur", cn: "必须" }, { uz: "qarshi", cn: "反对" } ] },
            { id: 23, title: "第二十三篇：求助", words: [ { uz: "iltimos", cn: "请求" }, { uz: "yordam", cn: "帮助" }, { uz: "qarz ber-", cn: "借钱" }, { uz: "politsiya", cn: "警察" }, { uz: "shikoyat qil-", cn: "投诉/报警" }, { uz: "o‘g‘irla-", cn: "被偷" }, { uz: "yo'qot-", cn: "丢失" }, { uz: "xavfli", cn: "危险" } ] },
            { id: 24, title: "第二十四篇：乘车", words: [ { uz: "transport", cn: "交通" }, { uz: "avtobus", cn: "公交车" }, { uz: "taksi", cn: "出租车" }, { uz: "metro", cn: "地铁" }, { uz: "bekat", cn: "车站" }, { uz: "manzil", cn: "地址" }, { uz: "qayril-", cn: "转弯" }, { uz: "svetofor", cn: "红绿灯" }, { uz: "xarita", cn: "地图" } ] },
            { id: 25, title: "第二十五篇：祝贺与祝愿", words: [ { uz: "tabrikla-", cn: "祝贺" }, { uz: "tug‘ilgan kun", cn: "生日" }, { uz: "yangi yil", cn: "新年" }, { uz: "bayram", cn: "节日" }, { uz: "baxt", cn: "幸福" }, { uz: "omad", cn: "好运" }, { uz: "sog‘lik", cn: "健康" }, { uz: "uzoq umr", cn: "长寿" }, { uz: "oq yo‘l", cn: "一路顺风" } ] }
        ];

        const AudioStatus = ({ status, text, engine, voice }) => {
            let label = "";
            let icon = null;
            let colorClass = "";

            if (status === 'loading') {
                return (
                    <div className="absolute top-3 left-3 flex items-center gap-1.5 bg-slate-100/90 backdrop-blur text-slate-700 px-2 py-1 rounded-full text-[10px] sm:text-xs font-medium shadow-sm z-20 animate-in fade-in slide-in-from-top-2">
                        <Icon name="Loader2" size={12} className="animate-spin" />
                        <span>加载中...</span>
                    </div>
                );
            }

            if (status === 'playing_real') {
                label = `录音: ${text}`;
                icon = "FileAudio";
                colorClass = "bg-green-100/90 text-green-700";
            } else if (status === 'playing_gemini') {
                label = `Gemini (${voice})`;
                icon = "Sparkles";
                colorClass = "bg-indigo-100/90 text-indigo-700";
            } else if (status === 'playing_openai') {
                label = "OpenAI (Alloy)";
                icon = "Zap";
                colorClass = "bg-teal-100/90 text-teal-700";
            } else if (status === 'playing_synth') {
                label = "合成发音";
                icon = "Mic";
                colorClass = "bg-amber-100/90 text-amber-700";
            } else if (status === 'error') {
                return (
                    <div className="absolute top-3 left-3 flex items-center gap-1.5 bg-red-100/90 backdrop-blur text-red-700 px-2 py-1 rounded-full text-[10px] sm:text-xs font-medium shadow-sm z-20 animate-in fade-in slide-in-from-top-2">
                        <Icon name="AlertCircle" size={12} />
                        <span className="truncate max-w-[180px]">API错误: {text}</span>
                    </div>
                );
            }

            if (!label) return null;

            return (
                <div className={`absolute top-3 left-3 flex items-center gap-1.5 px-2 py-1 rounded-full text-[10px] sm:text-xs font-medium shadow-sm z-20 animate-in fade-in slide-in-from-top-2 backdrop-blur ${colorClass}`}>
                    <Icon name={icon} size={12} className="opacity-80" />
                    <span className="truncate max-w-[150px]">{label}</span>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, geminiKey, setGeminiKey, openAIKey, setOpenAIKey, voiceEngine, setVoiceEngine, geminiVoice, setGeminiVoice }) => {
            const [localGeminiKey, setLocalGeminiKey] = useState(geminiKey);
            const [localOpenAIKey, setLocalOpenAIKey] = useState(openAIKey);
            const [showSaved, setShowSaved] = useState(false);

            useEffect(() => {
                setLocalGeminiKey(geminiKey);
                setLocalOpenAIKey(openAIKey);
            }, [geminiKey, openAIKey]);

            const handleSave = () => {
                const gKey = localGeminiKey.trim();
                const oKey = localOpenAIKey.trim();
                setGeminiKey(gKey);
                setOpenAIKey(oKey);
                localStorage.setItem('gemini_api_key', gKey);
                localStorage.setItem('openai_api_key', oKey);
                setShowSaved(true);
                setTimeout(() => setShowSaved(false), 2000);
            };

            if (!isOpen) return null;

            // Gemini 语音列表
            const geminiVoices = [
                { id: "Puck", name: "Puck (男声-自然)" },
                { id: "Charon", name: "Charon (男声-深沉)" },
                { id: "Kore", name: "Kore (女声-清晰)" },
                { id: "Fenrir", name: "Fenrir (男声-有力)" },
                { id: "Aoede", name: "Aoede (女声-柔和)" },
            ];

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4">
                    <div className="bg-white rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in slide-in-from-bottom-10 sm:zoom-in-95 duration-200">
                        <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                <Icon name="Settings" size={20} className="text-slate-500"/>
                                语音设置
                            </h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        
                        <div className="p-6 pb-8 sm:pb-6 space-y-6 max-h-[70vh] overflow-y-auto">
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">选择语音引擎</label>
                                <div className="flex gap-2 p-1 bg-slate-100 rounded-lg">
                                    <button 
                                        onClick={() => { setVoiceEngine('gemini'); localStorage.setItem('voice_engine', 'gemini'); }}
                                        className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all ${voiceEngine === 'gemini' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        Gemini AI
                                    </button>
                                    <button 
                                        onClick={() => { setVoiceEngine('openai'); localStorage.setItem('voice_engine', 'openai'); }}
                                        className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all ${voiceEngine === 'openai' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        OpenAI
                                    </button>
                                </div>
                            </div>

                            <div className={voiceEngine === 'gemini' ? 'block space-y-4' : 'hidden'}>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                        <Icon name="Sparkles" size={16} className="text-indigo-500" />
                                        Gemini API Key
                                    </label>
                                    <input 
                                        type="password" 
                                        value={localGeminiKey}
                                        onChange={(e) => setLocalGeminiKey(e.target.value)}
                                        placeholder="AIza..."
                                        className="w-full pl-3 pr-10 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors text-base sm:text-sm font-mono"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                        <Icon name="User" size={16} className="text-indigo-500" />
                                        语音角色 (Voice)
                                    </label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {geminiVoices.map(v => (
                                            <button
                                                key={v.id}
                                                onClick={() => { setGeminiVoice(v.id); localStorage.setItem('gemini_voice', v.id); }}
                                                className={`py-2 px-3 text-xs sm:text-sm rounded-lg border text-left transition-all ${geminiVoice === v.id ? 'border-indigo-500 bg-indigo-50 text-indigo-700 font-medium' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}
                                            >
                                                {v.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className={voiceEngine === 'openai' ? 'block' : 'hidden'}>
                                <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                    <Icon name="Zap" size={16} className="text-teal-500" />
                                    OpenAI API Key
                                </label>
                                <input 
                                    type="password" 
                                    value={localOpenAIKey}
                                    onChange={(e) => setLocalOpenAIKey(e.target.value)}
                                    placeholder="sk-..."
                                    className="w-full pl-3 pr-10 py-3 border-2 border-slate-200 rounded-xl focus:border-teal-500 focus:outline-none transition-colors text-base sm:text-sm font-mono"
                                />
                                <p className="text-[10px] text-slate-400 mt-2">OpenAI TTS-1 模型发音自然，但需付费账号。</p>
                            </div>

                            <button 
                                onClick={handleSave}
                                className={`w-full py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-all active:scale-[0.98] ${showSaved ? 'bg-green-500 text-white' : 'bg-slate-800 hover:bg-slate-900 text-white'}`}
                            >
                                {showSaved ? (
                                    <>已保存 <Icon name="Save" size={18} /></>
                                ) : (
                                    <>保存设置 <Icon name="Save" size={18} /></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SVGFlashcard = ({ word, isFlipped, onClick, onSpeak, audioState, geminiVoice }) => {
            return (
                <div 
                    className="relative w-full max-w-sm sm:max-w-md aspect-[4/3] sm:aspect-[4/3] cursor-pointer perspective-1000 group select-none mx-auto"
                    onClick={onClick}
                >
                    <div 
                        className={`w-full h-full transition-all duration-500 transform-style-3d relative ${isFlipped ? 'rotate-y-180' : ''}`}
                    >
                        <div className="absolute w-full h-full backface-hidden">
                            <svg viewBox="0 0 400 300" className="w-full h-full drop-shadow-xl rounded-2xl">
                                <defs>
                                    <linearGradient id="cardGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stopColor="#f0f9ff" />
                                        <stop offset="100%" stopColor="#e0f2fe" />
                                    </linearGradient>
                                    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#bae6fd" strokeWidth="0.5"/>
                                    </pattern>
                                </defs>
                                
                                {/* Background Rect */}
                                <rect x="0" y="0" width="400" height="300" rx="24" ry="24" fill="url(#cardGradient)" stroke="#0ea5e9" strokeWidth="4" />
                                <rect x="10" y="10" width="380" height="280" rx="16" ry="16" fill="url(#grid)" opacity="0.5" />
                                
                                {/* Decorations */}
                                <circle cx="40" cy="40" r="15" fill="#38bdf8" opacity="0.2" />
                                <circle cx="40" cy="40" r="8" fill="#0284c7" opacity="0.4" />

                                <foreignObject x="20" y="60" width="360" height="180">
                                    <div className="w-full h-full flex flex-col items-center justify-center p-2">
                                        <div className="text-xs sm:text-sm text-sky-600 font-semibold mb-2 uppercase tracking-wider">O'zbekcha</div>
                                        <div className="text-3xl sm:text-4xl font-bold text-slate-800 text-center break-words px-2 leading-tight">
                                            {word.uz}
                                        </div>
                                    </div>
                                </foreignObject>

                                <text x="200" y="275" textAnchor="middle" fontSize="12" fill="#64748b" className="animate-pulse font-sans">
                                    点击翻看 / Tap to flip
                                </text>
                                
                                {/* REMOVED: SVG Circle for Speaker Icon */}
                            </svg>
                            
                            <AudioStatus 
                                status={audioState.type} 
                                text={audioState.type === 'playing_real' ? getAudioFileName(word.uz).split('/').pop() : audioState.type === 'error' ? audioState.errorMsg : ''}
                                voice={geminiVoice}
                            />

                            {/* Updated Speaker Button: Styled as a circle with background and border */}
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onSpeak(word);
                                }}
                                className={`absolute top-[6%] right-[6%] w-12 h-12 flex items-center justify-center rounded-full border-2 shadow-sm transition-all z-30 ${
                                    audioState.isPlaying 
                                    ? 'bg-sky-50 border-sky-500 text-sky-600 animate-bounce' 
                                    : 'bg-white border-slate-200 text-sky-400 hover:border-sky-300 hover:text-sky-600 active:scale-95'
                                }`}
                                title="播放发音"
                            >
                                {audioState.type === 'loading' ? <Icon name="Loader2" size={24} className="animate-spin" /> : <Icon name="Volume2" size={24} />}
                            </button>
                        </div>

                        {/* Back Side (Chinese) */}
                        <div className="absolute w-full h-full backface-hidden rotate-y-180">
                            <svg viewBox="0 0 400 300" className="w-full h-full drop-shadow-xl rounded-2xl">
                                <defs>
                                    <linearGradient id="cardGradientBack" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stopColor="#fff1f2" />
                                        <stop offset="100%" stopColor="#ffe4e6" />
                                    </linearGradient>
                                </defs>
                                <rect x="0" y="0" width="400" height="300" rx="24" ry="24" fill="url(#cardGradientBack)" stroke="#f43f5e" strokeWidth="4" />
                                <path d="M 30 270 L 370 270" stroke="#fda4af" strokeWidth="2" strokeDasharray="5,5" />
                                <foreignObject x="20" y="50" width="360" height="200">
                                    <div className="w-full h-full flex flex-col items-center justify-center p-2">
                                        <div className="text-xs sm:text-sm text-rose-500 font-semibold mb-2 uppercase tracking-wider">Xitoycha</div>
                                        <div className="text-2xl sm:text-3xl font-bold text-slate-800 text-center px-2 leading-normal">
                                            {word.cn}
                                        </div>
                                    </div>
                                </foreignObject>
                            </svg>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [selectedChapterId, setSelectedChapterId] = useState(1);
            const [currentWordIndex, setCurrentWordIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isAutoPlay, setIsAutoPlay] = useState(false);
            const [shuffled, setShuffled] = useState(false);
            const [showVocabList, setShowVocabList] = useState(false);
            
            // Settings
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [geminiKey, setGeminiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [openAIKey, setOpenAIKey] = useState(() => localStorage.getItem('openai_api_key') || '');
            const [voiceEngine, setVoiceEngine] = useState(() => localStorage.getItem('voice_engine') || 'gemini');
            const [geminiVoice, setGeminiVoice] = useState(() => localStorage.getItem('gemini_voice') || 'Puck');

            const [audioState, setAudioState] = useState({ isPlaying: false, type: 'idle', errorMsg: '' }); 
            const currentChapter = VOCABULARY_DATA.find(c => c.id === selectedChapterId) || VOCABULARY_DATA[0];
            const [displayList, setDisplayList] = useState(currentChapter.words);

            const playBrowserSpeech = (text) => {
                if (!('speechSynthesis' in window)) {
                    setAudioState({ isPlaying: false, type: 'idle' });
                    return;
                }
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.lang === 'uz-UZ' || v.lang === 'uz') || voices.find(v => v.lang.includes('tr')) || voices.find(v => v.lang.includes('ru'));
                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.lang = 'uz-UZ'; 
                utterance.rate = 0.85; 
                utterance.onend = () => setAudioState({ isPlaying: false, type: 'idle' });
                utterance.onerror = () => setAudioState({ isPlaying: false, type: 'idle' });
                window.speechSynthesis.speak(utterance);
            };

            const playSyntheticFallback = (text, errorMsg = '') => {
                if (errorMsg) {
                    setAudioState({ isPlaying: false, type: 'error', errorMsg });
                    setTimeout(() => {
                        setAudioState({ isPlaying: true, type: 'playing_synth' });
                        playBrowserSpeech(text);
                    }, 2000);
                    return;
                }
                setAudioState({ isPlaying: true, type: 'playing_synth' });
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=uz&q=${encodeURIComponent(text)}`;
                const audio = new Audio(url);
                audio.onended = () => setAudioState({ isPlaying: false, type: 'idle' });
                audio.onerror = () => {
                    console.log("Google Web TTS failed, fallback to Browser");
                    playBrowserSpeech(text);
                };
                audio.play().catch(() => playBrowserSpeech(text));
            };

            const playGemini = async (text) => {
                setAudioState({ isPlaying: true, type: 'loading' });
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: text }] }], 
                            generationConfig: { 
                                responseModalities: ["AUDIO"], 
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: geminiVoice } } } 
                            } 
                        }),
                    });
                    if (!response.ok) {
                        let errorMessage = `Status ${response.status}`;
                        try { const e = await response.json(); if(e.error) errorMessage = e.error.message; } catch(e){}
                        throw new Error(errorMessage);
                    }
                    const data = await response.json();
                    const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!base64Audio) throw new Error("No audio data");
                    const wavBlob = pcm16ToWavBlob(base64Audio, 24000);
                    const url = URL.createObjectURL(wavBlob);
                    const audio = new Audio(url);
                    audio.onended = () => setAudioState({ isPlaying: false, type: 'idle' });
                    audio.onerror = () => playSyntheticFallback(text);
                    setAudioState({ isPlaying: true, type: 'playing_gemini' });
                    await audio.play();
                } catch (error) {
                    console.error("Gemini Error:", error);
                    playSyntheticFallback(text, error.message);
                }
            };

            const playOpenAI = async (text) => {
                setAudioState({ isPlaying: true, type: 'loading' });
                try {
                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${openAIKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: 'tts-1', input: text, voice: 'alloy' }),
                    });
                    if (!response.ok) {
                        let errorMessage = `Status ${response.status}`;
                        try { const e = await response.json(); if(e.error) errorMessage = e.error.message; } catch(e){}
                        throw new Error(errorMessage);
                    }
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio.onended = () => setAudioState({ isPlaying: false, type: 'idle' });
                    audio.onerror = () => playSyntheticFallback(text);
                    setAudioState({ isPlaying: true, type: 'playing_openai' });
                    await audio.play();
                } catch (error) {
                    console.error("OpenAI Error:", error);
                    playSyntheticFallback(text, error.message);
                }
            };

            const playAudio = async (wordObj) => {
                const text = wordObj.uz;
                const audioPath = getAudioFileName(text);
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                try {
                    const audio = new Audio(audioPath);
                    const playPromise = new Promise((resolve, reject) => {
                        audio.onended = () => resolve('ended');
                        audio.onerror = (e) => reject(e);
                        audio.play().then(() => { setAudioState({ isPlaying: true, type: 'playing_real' }); }).catch(err => reject(err));
                    });
                    await playPromise;
                    setAudioState({ isPlaying: false, type: 'idle' });
                } catch (e) {
                    if (voiceEngine === 'openai' && openAIKey && openAIKey.length > 10) {
                        playOpenAI(text);
                    } else if (voiceEngine === 'gemini' && geminiKey && geminiKey.length > 10) {
                        playGemini(text);
                    } else {
                        playSyntheticFallback(text);
                    }
                }
            };

            useEffect(() => { setCurrentWordIndex(0); setIsFlipped(false); setIsAutoPlay(false); setAudioState({ isPlaying: false, type: 'idle' }); if (shuffled) { setDisplayList([...currentChapter.words].sort(() => Math.random() - 0.5)); } else { setDisplayList(currentChapter.words); } }, [selectedChapterId, shuffled]);
            useEffect(() => { let interval; if (isAutoPlay) { interval = setInterval(() => { if (!isFlipped) { playAudio(displayList[currentWordIndex]); setTimeout(() => setIsFlipped(true), 3500); } else { handleNext(); setIsFlipped(false); } }, 7000); } return () => clearInterval(interval); }, [isAutoPlay, isFlipped, currentWordIndex, displayList]);

            const handleNext = () => { setIsFlipped(false); setCurrentWordIndex((prev) => (prev + 1) % displayList.length); };
            const handlePrev = () => { setIsFlipped(false); setCurrentWordIndex((prev) => (prev - 1 + displayList.length) % displayList.length); };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800 pb-20 sm:pb-0">
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} geminiKey={geminiKey} setGeminiKey={setGeminiKey} openAIKey={openAIKey} setOpenAIKey={setOpenAIKey} voiceEngine={voiceEngine} setVoiceEngine={setVoiceEngine} geminiVoice={geminiVoice} setGeminiVoice={setGeminiVoice} />
                    <header className="bg-sky-600 text-white px-4 py-3 shadow-lg sticky top-0 z-40">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            {/* Left side: Title and attribution */}
                            <div className="flex flex-col">
                                <div className="flex items-center space-x-2">
                                    <Icon name="BookOpen" size={20} className="sm:w-6 sm:h-6"/>
                                    <h1 className="text-lg sm:text-xl font-bold">乌兹别克语速记</h1>
                                </div>
                                <div className="text-[9px] sm:text-xs text-sky-100 font-light mt-1 ml-1 sm:ml-0">
                                   Design by Dilfuza(telegram:@diffila) 小红书号：410803917
                                </div>
                            </div>
                    
                            {/* Right side: Count and Settings */}
                            <div className="flex items-center gap-2">
                                <div className="text-xs bg-sky-700/50 px-2 py-1 rounded-full font-mono hidden sm:block">
                                    {displayList.length} 词
                                </div>
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className={`p-2 rounded-full transition-colors ${
                                        (voiceEngine === 'openai' && openAIKey) || (voiceEngine === 'gemini' && geminiKey)
                                        ? 'bg-sky-500 text-white hover:bg-sky-400' 
                                        : 'bg-sky-700/50 text-sky-100 hover:text-white'
                                    }`}
                                    title="设置"
                                >
                                    <Icon name="Settings" size={18} />
                                </button>
                            </div>
                        </div>
                    </header>
                    <main className="flex-1 max-w-4xl mx-auto w-full p-3 sm:p-4 flex flex-col items-center">
                        <div className="w-full flex flex-col sm:flex-row justify-between items-stretch gap-3 mb-6 bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                            <div className="w-full sm:w-2/3">
                                <select value={selectedChapterId} onChange={(e) => setSelectedChapterId(Number(e.target.value))} className="w-full p-2.5 rounded-lg border border-slate-200 bg-slate-50 text-sm font-medium focus:border-indigo-500 focus:bg-white focus:ring-0 transition-colors">
                                    {VOCABULARY_DATA.map(chapter => (<option key={chapter.id} value={chapter.id}>{chapter.title}</option>))}
                                </select>
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <button onClick={() => setShuffled(!shuffled)} className={`flex-1 py-2.5 px-3 rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${shuffled ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                    <Icon name="Shuffle" size={16} /> <span className="text-sm font-medium">乱序</span>
                                </button>
                                <button onClick={() => setIsAutoPlay(!isAutoPlay)} className={`flex-1 py-2.5 px-3 rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${isAutoPlay ? 'bg-green-50 border-green-200 text-green-600' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                    {isAutoPlay ? <Icon name="Pause" size={16} /> : <Icon name="Play" size={16} />} <span className="text-sm font-medium">自动</span>
                                </button>
                            </div>
                        </div>
                        <div className="w-full max-w-sm mb-4 flex justify-between items-center text-xs text-slate-400 font-medium px-2">
                            <span>进度 {currentWordIndex + 1} / {displayList.length}</span>
                            <div className="w-24 sm:w-32 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-sky-500 transition-all duration-300 ease-out" style={{ width: `${((currentWordIndex + 1) / displayList.length) * 100}%` }} />
                            </div>
                        </div>
                        <div className="w-full flex justify-center mb-6 sm:mb-8">
                            <SVGFlashcard word={displayList[currentWordIndex]} isFlipped={isFlipped} onClick={() => setIsFlipped(!isFlipped)} onSpeak={playAudio} audioState={audioState} geminiVoice={geminiVoice} />
                        </div>
                        <div className="hidden sm:flex items-center gap-6 mb-8">
                            <button onClick={handlePrev} className="p-4 rounded-full bg-white shadow hover:shadow-lg border border-slate-100 text-slate-600 hover:text-sky-600 transition-all active:scale-95"><Icon name="ChevronLeft" size={32} /></button>
                            <button onClick={() => setIsFlipped(!isFlipped)} className="flex flex-col items-center gap-1 text-slate-400 hover:text-sky-600 transition-colors group"><Icon name="RotateCw" size={24} className="group-hover:rotate-180 transition-transform duration-500"/><span className="text-xs">翻转</span></button>
                            <button onClick={handleNext} className="p-4 rounded-full bg-white shadow hover:shadow-lg border border-slate-100 text-slate-600 hover:text-sky-600 transition-all active:scale-95"><Icon name="ChevronRight" size={32} /></button>
                        </div>
                        <div className="sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-3 pb-6 flex justify-between items-center px-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
                            <button onClick={handlePrev} className="p-3 rounded-2xl bg-slate-50 text-slate-600 active:bg-slate-200 active:scale-95 transition-all"><Icon name="ChevronLeft" size={28} /></button>
                            <button onClick={() => setIsFlipped(!isFlipped)} className="flex items-center gap-2 px-6 py-3 bg-sky-600 text-white rounded-xl font-medium shadow-md shadow-sky-200 active:scale-95 transition-all"><Icon name="RotateCw" size={20} /><span>翻转</span></button>
                            <button onClick={handleNext} className="p-3 rounded-2xl bg-slate-50 text-slate-600 active:bg-slate-200 active:scale-95 transition-all"><Icon name="ChevronRight" size={28} /></button>
                        </div>
                        <div className="w-full max-w-2xl">
                            <button onClick={() => setShowVocabList(!showVocabList)} className="w-full flex items-center justify-between p-4 bg-white rounded-xl border border-slate-100 shadow-sm text-slate-600 font-medium mb-4 active:bg-slate-50 sm:hidden"><span className="flex items-center gap-2"><Icon name="List" size={18}/> 查看本章词表</span><Icon name="ChevronRight" size={18} className={`transition-transform ${showVocabList ? 'rotate-90' : ''}`}/></button>
                            <div className={`w-full bg-white sm:bg-transparent rounded-xl border sm:border-0 border-slate-100 shadow-sm sm:shadow-none overflow-hidden transition-all duration-300 ${showVocabList ? 'max-h-[800px]' : 'max-h-0 sm:max-h-none'}`}>
                                <div className="p-4 sm:p-0 sm:bg-white sm:rounded-xl sm:border sm:border-slate-200 sm:shadow-sm">
                                    <h3 className="hidden sm:flex text-lg font-bold text-slate-700 mb-4 border-b pb-2 items-center justify-between"><span>本章词汇列表</span><span className="text-xs font-normal text-slate-400 flex items-center gap-1"><Icon name="Volume2" size={12}/> 点击播放发音</span></h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[60vh] sm:max-h-80 overflow-y-auto pr-2 custom-scrollbar">
                                        {displayList.map((item, idx) => (
                                            <div key={idx} className={`p-3 rounded-lg flex justify-between items-center border cursor-pointer hover:bg-sky-50 transition-all ${idx === currentWordIndex ? 'bg-sky-50 border-sky-300 ring-1 ring-sky-300 shadow-sm' : 'bg-white border-slate-100'}`} onClick={() => { setCurrentWordIndex(idx); setIsFlipped(false); if (window.innerWidth < 640) { window.scrollTo({ top: 0, behavior: 'smooth' }); } }}>
                                                <div className="flex items-center gap-3"><button onClick={(e) => { e.stopPropagation(); playAudio(item); }} className="text-sky-400 hover:text-sky-600 p-2 hover:bg-sky-100 rounded-full transition-colors shrink-0"><Icon name="Volume2" size={18} /></button><div className="flex flex-col"><span className="font-semibold text-sky-700 text-lg sm:text-base">{item.uz}</span></div></div><span className="text-slate-500 text-sm font-medium">{item.cn}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
